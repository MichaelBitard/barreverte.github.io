---
layout: post
title: faire du TDD javascript en ligne de commande avec QUnit
tags:
- bruno
- javascript
- tdd
- tests
status: publish
type: post
published: true
meta:
  _edit_last: '2'
---
Récemment, j'ai voulu faire du TDD en ligne de commande (sans utiliser de navigateur), en javascript. J'ai eu beaucoup de mal à trouver une solution simple.

J'ai voulu utiliser <a href="http://www.jsunit.net/">JSUnit</a> qui m'avait l'air assez répandu, mais il ne fait pas (simplement) de ligne de commande. Ou bien je n'ai pas trouvé, ou bien il fallait redévelopper une petite couche javascript par dessus. J'ai aussi voulu tester doh (<a href="http://dojotoolkit.org/reference-guide/util/doh.html">Dojo Objective Harness</a>), qui normalement est plutôt prévu pour faire des tests de <a href="http://dojotoolkit.org/">dojo</a>.
<!--more-->
Et puis j'ai trouvé <a href="http://docs.jquery.com/Qunit">QUnit</a>, qui paraissait lié à jQuery. Comme nous utilisons <a href="http://jquery.com/">jQuery</a>, il semblait plus logique d'utiliser cet outil. En l'utilisant, je me suis rendu compte qu'il ne nécessitait pas jQuery.

<a href="http://twoguysarguing.wordpress.com/2010/11/26/qunit-cli-running-qunit-with-rhino/">Cet article</a> indique une version modifiée de QUnit qui fait le lien entre QUnit et QUnit-CLI. Téléchargez les 2 projets :
- <a href="https://github.com/asynchrony/qunit/tree/consistent-checks">QUnit modifié</a>
- <a href="https://github.com/benjaminplee/QUnit-CLI">QUnit-CLI</a>

Je vous propose une arbo projet comme celle-ci :
<pre lang="sh">`-- src
    |-- main
    |   `-- js
    |       `-- monJavascript.js
    `-- test
        `-- js
            |-- lib
            |   |-- js.jar
            |   `-- qunit.js
            |-- suite.js
            `-- testMonJavascript.js</pre>
<ul>
	<li>js.jar est le jar rhino</li>
	<li>qunit.js est le fichier source qunit qui est contenu dans le premier lien</li>
	<li>suite.js est le source javascript qui est dans QUnit-CLI/rhino</li>
</ul>
Il faut modifier <a href="https://github.com/benjaminplee/QUnit-CLI/blob/master/rhino/suite.js">suite.js</a> comme suit :
<ul>
	<li>supprimer la ligne <code>load("../src/myLib.js")</code>. J'ai préféré que ce soit chaque module javascript de test qui charge le code source correspondant</li>
	<li>changer la ligne <code>load("../qunit/qunit/qunit.js")</code> pour pointer vers lib/qunit.js : <code>load("lib/qunit.js")</code></li>
	<li>en bas de fichier il y a l'import de tous les sources de test et aussi des tests qunit. Supprimer le <code>load("../qunit/test/test.js")</code> et ajouter la ligne <code>load("testMonJavascript.js")</code></li>
</ul>
J'ai ensuite créé testMonJavascript.js comme suit :
<pre lang="javascript">load("../../main/js/monJavascript.js");

test("RetourneBienCoucou", function() {
	equals(coucou(), "coucou");
});</pre>
et exécuté :
<pre>~/src/projet_js/src/test/js$ java -jar  lib/js.jar  suite.js
js: Couldn't read source file "../../main/js/monJavascript.js:
    ../../main/js/monJavascript.js (No such file or directory)".
FAIL - RetourneBienCoucou
    FAIL|OK|Died on test #1: "coucou" n'est pas défini - ReferenceError
        { message: '"coucou" n'est pas défini', fileName: '', lineNumber: 0 }|
----------------------------------------
 PASS: 0  FAIL: 1  TOTAL: 1
 Finished in 0.045 seconds.
----------------------------------------</pre>
et créé monJavascript.js dans main/js :
<pre lang="javascript">function coucou() {  return "blah"; }</pre>
A présent l'exécution du test donne :
<pre lang="bash">~/src/projet_js/src/test/js$ java -jar  lib/js.jar  suite.js
FAIL - RetourneBienCoucou
    FAIL|EQ||Expected: coucou , Actual: blah
----------------------------------------
 PASS: 0  FAIL: 1  TOTAL: 1
 Finished in 0.035 seconds.
----------------------------------------</pre>
Et finalement en remplaçant par un return "coucou" :
<pre lang="bash">~/src/projet_js/src/test/js$ java -jar  lib/js.jar  suite.js
PASS - RetourneBienCoucou
----------------------------------------
 PASS: 1  FAIL: 0  TOTAL: 1
 Finished in 0.009 seconds.
----------------------------------------</pre>
Ceci permet de faire des tests javascript sans DOM. Nous verrons dans un prochain post comment faire des tests en simulant le navigateur avec env.js.
